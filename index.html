<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f8fafc; /* slate-50 */
            color: #1f2937; /* gray-800 */
        }
        .page-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .page-content.active {
            display: block;
        }
        .nav-link.active .link-text {
            color: #0ea5e9;
            font-weight: 600;
        }
        .nav-link.active .link-underline {
            transform: scaleX(1);
        }
        header {
            z-index: 50;
            background-color: #ffffff;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        table th, table td {
            text-align: center;
        }
        .chart-container {
            margin-top: 2rem;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Unified Color Scheme */
        .bg-white {
            background-color: #ffffff;
            border-color: #e2e8f0; /* slate-200 */
        }
        .bg-slate-50 {
            background-color: #f8fafc;
        }
        .bg-slate-100 {
            background-color: #f1f5f9; /* slate-100 */
        }
        .text-gray-900 {
            color: #111827;
        }
        .text-gray-600 {
            color: #4b5563;
        }
        .text-gray-500 {
            color: #6b7280;
        }
        table tbody tr:hover {
            background-color: #f0f9ff; /* sky-50 */
        }
        .bg-gradient-to-br {
            background-image: linear-gradient(to bottom right, #ffffff, #f0f9ff);
        }
        input, select {
            background-color: #ffffff;
            border-color: #e2e8f0;
            color: #111827;
        }
        .animate-pulse-once {
            animation: pulse-once 2s ease-in-out;
        }
        @keyframes pulse-once {
            0% { transform: scale(1); }
            50% { transform: scale(1.01); }
            100% { transform: scale(1); }
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

<!-- Confirmation Modal -->
<div id="confirmation-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-2xl p-8 shadow-xl max-w-sm w-full">
        <h3 id="modal-title" class="text-xl font-bold text-gray-900 mb-4">Confirm Action</h3>
        <p id="modal-message" class="text-gray-600 mb-6"></p>
        <div class="flex justify-end space-x-4">
            <button id="modal-cancel" class="px-6 py-2 rounded-xl text-gray-600 border border-gray-300 hover:bg-gray-50 transition-colors">Cancel</button>
            <button id="modal-confirm" class="px-6 py-2 rounded-xl text-white bg-red-600 hover:bg-red-700 transition-colors">Confirm</button>
        </div>
    </div>
</div>

<!-- Display Name Modal -->
<div id="display-name-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-2xl p-8 shadow-xl max-w-sm w-full">
        <h3 class="text-xl font-bold text-gray-900 mb-4 text-center">Set Your Display Name</h3>
        <p class="text-gray-600 mb-6 text-center">This name will be shown in the activity log for all users.</p>
        <form id="display-name-form" class="space-y-4">
            <input type="text" id="display-name-input" placeholder="Your Name" class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500 transition-all" required>
            <button type="submit" class="w-full px-4 py-3 bg-sky-600 text-white font-semibold rounded-xl hover:bg-sky-700 transition-colors">Save Name</button>
        </form>
    </div>
</div>

<!-- Edit Stock Item Modal -->
<div id="edit-stock-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-2xl p-8 shadow-xl max-w-lg w-full">
        <h3 class="text-xl font-bold text-gray-900 mb-4">Edit Stock Item</h3>
        <form id="edit-stock-form" class="space-y-4">
            <input type="hidden" id="edit-stock-id">
            <div>
                <label for="edit-itemName" class="block text-sm font-medium text-gray-700">Item Name</label>
                <input type="text" id="edit-itemName" name="itemName" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3" required>
            </div>
            <div>
                <label for="edit-itemCategory" class="block text-sm font-medium text-gray-700">Category</label>
                <input type="text" id="edit-itemCategory" name="itemCategory" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3">
            </div>
            <div>
                <label for="edit-itemType" class="block text-sm font-medium text-gray-700">Type</label>
                <select id="edit-itemType" name="itemType" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3">
                    <option value="New">New</option>
                    <option value="Used">Used</option>
                </select>
            </div>
            <div>
                <label for="edit-itemVendor" class="block text-sm font-medium text-gray-700">Vendor</label>
                <select id="edit-itemVendor" name="itemVendor" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3"></select>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="edit-itemQuantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                    <input type="number" id="edit-itemQuantity" name="itemQuantity" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3" required min="0">
                </div>
                <div>
                    <label for="edit-itemUnit" class="block text-sm font-medium text-gray-700">Unit</label>
                    <select id="edit-itemUnit" name="itemUnit" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3">
                        <option value="pcs">pieces</option>
                        <option value="kg">kg</option>
                        <option value="m">m</option>
                        <option value="l">L</option>
                        <option value="g">g</option>
                        <option value="mm">mm</option>
                    </select>
                </div>
            </div>
            <div>
                <label for="edit-itemPrice" class="block text-sm font-medium text-gray-700">Price per Unit</label>
                <input type="number" id="edit-itemPrice" name="itemPrice" step="0.01" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3" required min="0">
            </div>
            <div>
                <label for="edit-itemMinStock" class="block text-sm font-medium text-gray-700">Minimum Stock</label>
                <input type="number" id="edit-itemMinStock" name="itemMinStock" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3" required min="0">
            </div>
            <div class="flex justify-end space-x-4">
                <button type="button" id="edit-stock-cancel" class="px-6 py-2 rounded-xl text-gray-600 border border-gray-300 hover:bg-gray-50 transition-colors">Cancel</button>
                <button type="submit" class="px-6 py-2 rounded-xl text-white bg-sky-600 hover:bg-sky-700 transition-colors">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Vendor Modal -->
<div id="edit-vendor-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-2xl p-8 shadow-xl max-w-lg w-full">
        <h3 class="text-xl font-bold text-gray-900 mb-4">Edit Vendor</h3>
        <form id="edit-vendor-form" class="space-y-4">
            <input type="hidden" id="edit-vendor-id">
            <div>
                <label for="edit-vendorName" class="block text-sm font-medium text-gray-700">Vendor Name</label>
                <input type="text" id="edit-vendorName" name="vendorName" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3" required>
            </div>
            <div>
                <label for="edit-contactPerson" class="block text-sm font-medium text-gray-700">Contact Person</label>
                <input type="text" id="edit-contactPerson" name="contactPerson" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3">
            </div>
            <div>
                <label for="edit-contactEmail" class="block text-sm font-medium text-gray-700">Contact Email</label>
                <input type="email" id="edit-contactEmail" name="contactEmail" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3">
            </div>
            <div class="flex justify-end space-x-4">
                <button type="button" id="edit-vendor-cancel" class="px-6 py-2 rounded-xl text-gray-600 border border-gray-300 hover:bg-gray-50 transition-colors">Cancel</button>
                <button type="submit" class="px-6 py-2 rounded-xl text-white bg-sky-600 hover:bg-sky-700 transition-colors">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<div id="login-page" class="page-content active">
    <div class="flex items-center justify-center min-h-screen bg-slate-50">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
            <h1 class="text-3xl font-bold text-gray-900 mb-6" id="auth-title">Log in to IMS</h1>
            
            <div id="login-section">
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500 transition-all" required>
                    <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500 transition-all" required>
                    <button type="submit" class="w-full px-4 py-3 bg-sky-600 text-white font-semibold rounded-xl hover:bg-sky-700 transition-colors">Log In</button>
                </form>
                <button id="switch-to-signup" class="mt-4 text-sm text-gray-600 hover:text-sky-600 transition-colors">Don't have an account? Sign up</button>
            </div>

            <div id="signup-section" class="hidden">
                <form id="signup-form" class="space-y-4">
                    <input type="email" id="signup-email" placeholder="Email" class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500 transition-all" required>
                    <input type="password" id="signup-password" placeholder="Password" class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500 transition-all" required>
                    <button type="submit" class="w-full px-4 py-3 bg-sky-600 text-white font-semibold rounded-xl hover:bg-sky-700 transition-colors">Sign Up</button>
                </form>
                <button id="switch-to-login" class="mt-4 text-sm text-gray-600 hover:text-sky-600 transition-colors">Already have an account? Log in</button>
            </div>

            <p class="text-gray-500 my-4">or</p>
            <button id="anonymous-login-button" class="w-full px-4 py-3 border border-gray-300 text-gray-800 font-semibold rounded-xl hover:bg-gray-50 transition-colors">Continue Anonymously</button>
            
            <p id="login-error" class="text-red-500 text-sm mt-4"></p>
        </div>
    </div>
</div>

<div id="main-app" class="hidden">
    <header class="shadow-sm sticky top-0 transition-shadow duration-300">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="#home" class="flex-shrink-0">
                    <span class="text-3xl font-extrabold text-sky-600">IMS</span>
                </a>
                <div class="hidden md:flex space-x-6">
                    <a href="#home" class="nav-link text-gray-600 hover:text-sky-600 transition-colors font-medium relative group" data-page="home-page">
                        <span class="link-text">Home</span>
                        <span class="link-underline absolute bottom-0 left-0 w-full h-0.5 bg-sky-600 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></span>
                    </a>
                    <a href="#dashboard" class="nav-link text-gray-600 hover:text-sky-600 transition-colors font-medium relative group" data-page="dashboard-page">
                        <span class="link-text">Dashboard</span>
                        <span class="link-underline absolute bottom-0 left-0 w-full h-0.5 bg-sky-600 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></span>
                    </a>
                    <a href="#stock-details" class="nav-link text-gray-600 hover:text-sky-600 transition-colors font-medium relative group" data-page="stock-details-page">
                        <span class="link-text">Stock Details</span>
                        <span class="link-underline absolute bottom-0 left-0 w-full h-0.5 bg-sky-600 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></span>
                    </a>
                    <a href="#add-new-stock" class="nav-link text-gray-600 hover:text-sky-600 transition-colors font-medium relative group" data-page="add-new-stock-page">
                        <span class="link-text">Add New Stock</span>
                        <span class="link-underline absolute bottom-0 left-0 w-full h-0.5 bg-sky-600 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></span>
                    </a>
                    <a href="#use-stock" class="nav-link text-gray-600 hover:text-sky-600 transition-colors font-medium relative group" data-page="use-stock-page">
                        <span class="link-text">Use Stock</span>
                        <span class="link-underline absolute bottom-0 left-0 w-full h-0.5 bg-sky-600 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></span>
                    </a>
                    <a href="#used-stock" class="nav-link text-gray-600 hover:text-sky-600 transition-colors font-medium relative group" data-page="used-stock-page">
                        <span class="link-text">Used Stock</span>
                        <span class="link-underline absolute bottom-0 left-0 w-full h-0.5 bg-sky-600 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></span>
                    </a>
                    <a href="#vendors" class="nav-link text-gray-600 hover:text-sky-600 transition-colors font-medium relative group" data-page="vendors-page">
                        <span class="link-text">Vendors</span>
                        <span class="link-underline absolute bottom-0 left-0 w-full h-0.5 bg-sky-600 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></span>
                    </a>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <span id="user-display" class="bg-gray-100 text-gray-800 text-sm font-medium py-2 px-4 rounded-full shadow-inner"></span>
                <button id="logout-button" class="px-4 py-2 text-sm font-medium text-red-600 rounded-lg shadow-sm hover:bg-red-50 transition-colors">Log Out</button>
                <button id="mobile-menu-button" class="md:hidden text-gray-600 hover:text-gray-900 focus:outline-none p-2 rounded-md">
                    <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                    </svg>
                </button>
            </div>
        </nav>
        <div id="mobile-menu" class="md:hidden bg-white shadow-md absolute top-full left-0 w-full py-2 hidden">
            <div class="px-2 pt-2 pb-3 space-y-1">
                <a href="#home" class="nav-link block px-3 py-2 rounded-lg text-base font-medium text-gray-600 hover:text-sky-600 hover:bg-gray-50" data-page="home-page">Home</a>
                <a href="#dashboard" class="nav-link block px-3 py-2 rounded-lg text-base font-medium text-gray-600 hover:text-sky-600 hover:bg-gray-50" data-page="dashboard-page">Dashboard</a>
                <a href="#stock-details" class="nav-link block px-3 py-2 rounded-lg text-base font-medium text-gray-600 hover:text-sky-600 hover:bg-gray-50" data-page="stock-details-page">Stock Details</a>
                <a href="#add-new-stock" class="nav-link block px-3 py-2 rounded-lg text-base font-medium text-gray-600 hover:text-sky-600 hover:bg-gray-50" data-page="add-new-stock-page">Add New Stock</a>
                <a href="#use-stock" class="nav-link block px-3 py-2 rounded-lg text-base font-medium text-gray-600 hover:text-sky-600 hover:bg-gray-50" data-page="use-stock-page">Use Stock</a>
                <a href="#used-stock" class="nav-link block px-3 py-2 rounded-lg text-base font-medium text-gray-600 hover:text-sky-600 hover:bg-gray-50" data-page="used-stock-page">Used Stock</a>
                <a href="#vendors" class="nav-link block px-3 py-2 rounded-lg text-base font-medium text-gray-600 hover:text-sky-600 hover:bg-gray-50" data-page="vendors-page">Vendors</a>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="home-page" class="page-content active">
            <div class="bg-gradient-to-br from-white to-sky-50 rounded-2xl shadow-xl p-8 lg:p-12 text-center">
                <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-900 mb-4 tracking-tight">
                    Welcome to Your <span class="text-sky-600">Inventory Management System</span>
                </h1>
                <p class="text-lg text-gray-600 max-w-2xl mx-auto mb-8 leading-relaxed">
                    Efficiently manage your stock, track inventory levels, and streamline your operations with our intuitive and modern platform.
                </p>
                <a href="#dashboard" class="nav-link inline-flex items-center justify-center px-8 py-4 border border-transparent text-base font-medium rounded-xl shadow-lg text-white bg-sky-600 hover:bg-sky-700 transition-colors group" data-page="dashboard-page">
                    <span class="group-hover:translate-x-1 transition-transform duration-300">Go to Dashboard</span>
                    <svg class="ml-2 w-5 h-5 transition-transform duration-300 group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </a>
            </div>
            
            <div id="quick-insights" class="mt-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4 text-center">Quick Insights</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:scale-[1.02] hover:shadow-xl border border-gray-100">
                        <p class="text-sm font-medium text-gray-500">Total Stock Items</p>
                        <p class="mt-1 text-4xl font-semibold text-gray-900" id="home-total-items">0</p>
                    </div>
                    <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:scale-[1.02] hover:shadow-xl border border-gray-100">
                        <p class="text-sm font-medium text-gray-500">Total Inventory Value</p>
                        <p class="mt-1 text-4xl font-semibold text-gray-900" id="home-total-value">$0.00</p>
                    </div>
                    <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:scale-[1.02] hover:shadow-xl border border-gray-100">
                        <p class="text-sm font-medium text-gray-500">Unique Categories</p>
                        <p class="mt-1 text-4xl font-semibold text-gray-900" id="home-unique-categories">0</p>
                    </div>
                </div>
            </div>

            <div class="mt-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Low Stock Alerts</h2>
                <div id="low-stock-alerts" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white rounded-2xl shadow-lg p-6 text-center border border-gray-100">
                        <p class="text-gray-500">No low stock items. All good! 😊</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard-page" class="page-content">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:scale-[1.02] hover:hover:shadow-xl border border-gray-100">
                    <p class="text-sm font-medium text-gray-500">Total Stock Items</p>
                    <p class="mt-1 text-4xl font-semibold text-gray-900" id="total-items">0</p>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:scale-[1.02] hover:shadow-xl border border-gray-100">
                    <p class="text-sm font-medium text-gray-500">Total Inventory Value</p>
                    <p class="mt-1 text-4xl font-semibold text-gray-900" id="total-value">$0.00</p>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:scale-[1.02] hover:shadow-xl border border-gray-100">
                    <p class="text-sm font-medium text-gray-500">Unique Categories</p>
                    <p class="mt-1 text-4xl font-semibold text-gray-900" id="unique-categories">0</p>
                </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-center">Top 5 Most Valuable Items</h3>
                    <canvas id="top-value-chart"></canvas>
                </div>
            </div>

            <div class="chart-container grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center border border-gray-100">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4 text-center">Stock Distribution by Category (Bar)</h3>
                    <canvas id="category-bar-chart"></canvas>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center border border-gray-100">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4 text-center">Stock Distribution by Category (Pie)</h3>
                    <canvas id="category-pie-chart"></canvas>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center border border-gray-100">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4 text-center">Low Stock Items</h3>
                    <canvas id="low-stock-chart"></canvas>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col border border-gray-100">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4 text-center">Recent Activity</h3>
                    <ul id="activity-feed" class="list-disc list-inside space-y-2">
                        <li class="text-gray-600">No recent activity.</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="stock-details-page" class="page-content">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">Stock Details</h2>
            <div class="mb-6 flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0">
                <input type="text" id="stock-search" placeholder="Search by item name..." class="w-full sm:w-1/3 rounded-xl border-gray-300 shadow-sm focus:ring-sky-500 focus:border-sky-500 p-3">
                <div class="flex flex-wrap items-center justify-end gap-2">
                    <select id="filter-category" class="rounded-xl border-gray-300 focus:ring-sky-500 focus:border-sky-500 p-2">
                        <option value="">All Categories</option>
                    </select>
                    <select id="filter-vendor" class="rounded-xl border-gray-300 focus:ring-sky-500 focus:border-sky-500 p-2">
                        <option value="">All Vendors</option>
                    </select>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="filter-low-stock" class="rounded text-red-600 focus:ring-red-500">
                        <span class="text-sm font-medium text-gray-700">Low Stock Only</span>
                    </label>
                    <button id="download-stock-csv" class="px-4 py-2 bg-sky-600 text-white font-medium rounded-xl shadow-sm hover:bg-sky-700 transition-colors">Download CSV</button>
                </div>
            </div>
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="stockTable">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="name">Item Name</th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="category">Category</th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Actual Quantity</th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="quantity">Current Quantity</th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Unit</th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Min Stock</th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor</th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Created By</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="add-new-stock-page" class="page-content">
            <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Add New Stock</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-4xl mx-auto">
                <div class="bg-white rounded-2xl shadow-lg p-8 border border-gray-100">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-4">Manual Entry</h3>
                    <form id="stockForm" class="space-y-6">
                        <div>
                            <label for="itemName" class="block text-sm font-medium text-gray-700">Item Name</label>
                            <input type="text" id="itemName" name="itemName" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:ring-sky-500 focus:border-sky-500 p-3" required>
                        </div>
                        <div>
                            <label for="itemCategory" class="block text-sm font-medium text-gray-700">Category</label>
                            <input type="text" id="itemCategory" name="itemCategory" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:ring-sky-500 focus:border-sky-500 p-3">
                        </div>
                        <div>
                            <label for="itemType" class="block text-sm font-medium text-gray-700">Type</label>
                            <select id="itemType" name="itemType" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:ring-sky-500 focus:border-sky-500 p-3">
                                <option value="New">New</option>
                                <option value="Used">Used</option>
                            </select>
                        </div>
                        <div>
                            <label for="itemVendor" class="block text-sm font-medium text-gray-700">Vendor</label>
                            <select id="itemVendor" name="itemVendor" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:ring-sky-500 focus:border-sky-500 p-3"></select>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="itemQuantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                                <input type="number" id="itemQuantity" name="itemQuantity" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:ring-sky-500 focus:border-sky-500 p-3" required min="0">
                            </div>
                            <div>
                                <label for="itemUnit" class="block text-sm font-medium text-gray-700">Unit</label>
                                <select id="itemUnit" name="itemUnit" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:ring-sky-500 focus:border-sky-500 p-3">
                                    <option value="pcs">pieces</option>
                                    <option value="kg">kg</option>
                                    <option value="m">m</option>
                                    <option value="l">L</option>
                                    <option value="g">g</option>
                                    <option value="mm">mm</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="itemPrice" class="block text-sm font-medium text-gray-700">Price per Unit</label>
                            <input type="number" id="itemPrice" name="itemPrice" step="0.01" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:ring-sky-500 focus:border-sky-500 p-3" required min="0">
                        </div>
                        <div>
                            <label for="itemMinStock" class="block text-sm font-medium text-gray-700">Minimum Stock</label>
                            <input type="number" id="itemMinStock" name="itemMinStock" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:ring-sky-500 focus:border-sky-500 p-3" value="0" required min="0">
                        </div>
                        <button type="submit" class="w-full sm:w-auto px-6 py-3 border border-transparent text-base font-medium rounded-xl shadow-sm text-white bg-sky-600 hover:bg-sky-700 transition-colors">Add Item</button>
                    </form>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-8 border border-gray-100">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-4">Quick Add</h3>
                    <div id="quick-add-buttons" class="space-y-4">
                        <button class="quick-add-btn w-full px-6 py-3 bg-sky-50 text-sky-600 rounded-xl font-medium shadow-sm hover:bg-sky-100 transition-colors" data-item-name="Screws" data-item-category="Hardware" data-item-type="New" data-item-quantity="100" data-item-price="0.05" data-item-min-stock="20" data-item-unit="pcs" data-item-vendor-id="">Add 100 Screws</button>
                        <button class="quick-add-btn w-full px-6 py-3 bg-sky-50 text-sky-600 rounded-xl font-medium shadow-sm hover:bg-sky-100 transition-colors" data-item-name="AA Batteries" data-item-category="Electronics" data-item-type="New" data-item-quantity="50" data-item-price="1.50" data-item-min-stock="10" data-item-unit="pcs" data-item-vendor-id="">Add 50 AA Batteries</button>
                        <button class="quick-add-btn w-full px-6 py-3 bg-sky-50 text-sky-600 rounded-xl font-medium shadow-sm hover:bg-sky-100 transition-colors" data-item-name="Light Bulbs" data-item-category="Lighting" data-item-type="New" data-item-quantity="20" data-item-price="5.00" data-item-min-stock="5" data-item-unit="pcs" data-item-vendor-id="">Add 20 Light Bulbs</button>
                    </div>
                    <button id="create-quick-add-btn" class="mt-4 w-full px-6 py-3 border border-sky-600 text-sky-600 rounded-xl font-medium shadow-sm hover:bg-sky-600 hover:text-white transition-colors">Create New Quick Add</button>
                </div>
            </div>
        </div>

        <div id="use-stock-page" class="page-content">
            <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Use Stock</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-4xl mx-auto">
                <div class="bg-white rounded-2xl shadow-lg p-8 border border-gray-100">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-4">Log a Usage</h3>
                    <form id="useStockForm" class="space-y-6">
                        <div>
                            <label for="useItemSelect" class="block text-sm font-medium text-gray-700">Select Item</label>
                            <select id="useItemSelect" name="useItemSelect" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:ring-sky-500 focus:border-sky-500 p-3"></select>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="useQuantity" class="block text-sm font-medium text-gray-700">Quantity to Use</label>
                                <input type="number" id="useQuantity" name="useQuantity" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:ring-sky-500 focus:border-sky-500 p-3" required min="1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Current Stock</label>
                                <p id="current-stock-info" class="mt-1 text-xl font-semibold text-gray-900">-</p>
                            </div>
                        </div>
                        <button type="submit" class="w-full sm:w-auto px-6 py-3 border border-transparent text-base font-medium rounded-xl shadow-sm text-white bg-red-600 hover:bg-red-700 transition-colors">Use Stock</button>
                    </form>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-8 border border-gray-100">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-4">Recent Transactions</h3>
                    <ul id="transaction-history" class="list-disc list-inside space-y-2">
                        <li class="text-gray-600">No recent transactions.</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="used-stock-page" class="page-content">
            <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Used Stock Report</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:scale-[1.02] hover:shadow-xl border border-gray-100">
                    <p class="text-sm font-medium text-gray-500">Total Items Used</p>
                    <p class="mt-1 text-4xl font-semibold text-gray-900" id="total-used-items">0</p>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 transform transition-all duration-300 hover:scale-[1.02] hover:shadow-xl border border-gray-100">
                    <p class="text-sm font-medium text-gray-500">Total Value of Used Stock</p>
                    <p class="mt-1 text-4xl font-semibold text-gray-900" id="total-used-value">$0.00</p>
                </div>
            </div>
            <div class="mb-6 flex justify-end items-center space-x-2">
                <input type="date" id="used-stock-date-filter" class="rounded-xl border-gray-300 shadow-sm focus:ring-sky-500 focus:border-sky-500 p-3">
                <button id="download-used-csv" class="px-4 py-2 bg-sky-600 text-white font-medium rounded-xl shadow-sm hover:bg-sky-700 transition-colors">Download CSV</button>
            </div>
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="usedStockTable">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Item Name</th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity Used</th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Unit</th>
                                <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Used On</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="vendors-page" class="page-content">
            <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Manage Vendors</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-4xl mx-auto">
                <div class="bg-white rounded-2xl shadow-lg p-8 border border-gray-100">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-4">Add a New Vendor</h3>
                    <form id="add-vendor-form" class="space-y-6">
                        <div>
                            <label for="vendorName" class="block text-sm font-medium text-gray-700">Vendor Name</label>
                            <input type="text" id="vendorName" name="vendorName" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:ring-sky-500 focus:border-sky-500 p-3" required>
                        </div>
                        <div>
                            <label for="contactPerson" class="block text-sm font-medium text-gray-700">Contact Person</label>
                            <input type="text" id="contactPerson" name="contactPerson" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:ring-sky-500 focus:border-sky-500 p-3">
                        </div>
                        <div>
                            <label for="contactEmail" class="block text-sm font-medium text-gray-700">Contact Email</label>
                            <input type="email" id="contactEmail" name="contactEmail" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:ring-sky-500 focus:border-sky-500 p-3">
                        </div>
                        <button type="submit" class="w-full sm:w-auto px-6 py-3 border border-transparent text-base font-medium rounded-xl shadow-sm text-white bg-sky-600 hover:bg-sky-700 transition-colors">Add Vendor</button>
                    </form>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-8 border border-gray-100">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-4">Vendor List</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200" id="vendorsTable">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor Name</th>
                                    <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Contact Person</th>
                                    <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Contact Email</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, deleteDoc, doc, updateDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDJw4FMtiaw5F8Kh4_4uyWLMf2-h-JAwYo",
  authDomain: "inventory-management-2435e.firebaseapp.com",
  projectId: "inventory-management-2435e",
  storageBucket: "inventory-management-2435e.firebasestorage.app",
  messagingSenderId: "240440583248",
  appId: "1:240440583248:web:1567c0bbb7ceebb7375d55"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
// Use the __app_id global variable for collaborative public data.
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
// To enable collaborative editing as you requested, the collections must be in a public path.
const stockCollection = collection(db, `artifacts/${appId}/public/data/stock`);
const usedStockCollection = collection(db, `artifacts/${appId}/public/data/usedStock`);
const vendorsCollection = collection(db, `artifacts/${appId}/public/data/vendors`);
const activityLogCollection = collection(db, `artifacts/${appId}/public/data/activityLog`);
setLogLevel('debug');

// Global data arrays for real-time updates
let allStockData = [];
let allUsedData = [];
let allVendorsData = [];

// UI Elements
const loginPage = document.getElementById('login-page');
const mainApp = document.getElementById('main-app');
const authTitle = document.getElementById('auth-title');
const loginSection = document.getElementById('login-section');
const signupSection = document.getElementById('signup-section');
const loginForm = document.getElementById('login-form');
const signupForm = document.getElementById('signup-form');
const anonymousLoginButton = document.getElementById('anonymous-login-button');
const loginEmailInput = document.getElementById('login-email');
const loginPasswordInput = document.getElementById('login-password');
const signupEmailInput = document.getElementById('signup-email');
const signupPasswordInput = document.getElementById('signup-password');
const loginErrorEl = document.getElementById('login-error');
const logoutButton = document.getElementById('logout-button');
const userDisplay = document.getElementById('user-display');
const switchToSignupButton = document.getElementById('switch-to-signup');
const switchToLoginButton = document.getElementById('switch-to-login');

// Display Name Modal
const displayNameModal = document.getElementById('display-name-modal');
const displayNameForm = document.getElementById('display-name-form');
const displayNameInput = document.getElementById('display-name-input');

// Edit Modals
const editStockModal = document.getElementById('edit-stock-modal');
const editStockForm = document.getElementById('edit-stock-form');
const editStockCancelBtn = document.getElementById('edit-stock-cancel');
const editVendorModal = document.getElementById('edit-vendor-modal');
const editVendorForm = document.getElementById('edit-vendor-form');
const editVendorCancelBtn = document.getElementById('edit-vendor-cancel');

// Page Navigation
const pages = document.querySelectorAll(".page-content");
const mobileMenuButton = document.getElementById("mobile-menu-button");
const mobileMenu = document.getElementById("mobile-menu");

// Event delegation for all nav links
document.body.addEventListener("click", e => {
    const link = e.target.closest(".nav-link");
    if (link) {
        e.preventDefault();
        const pageId = link.dataset.page;
        showPage(pageId);
        if (pageId === "stock-details-page") displayStockData(allStockData);
        if (pageId === "dashboard-page") updateDashboard(allStockData);
        if (pageId === "use-stock-page") loadStockOptions();
        if (pageId === "used-stock-page") updateUsedStock(allUsedData);
    }
});

function showPage(pageId){
    pages.forEach(p=>p.classList.remove("active"));
    document.getElementById(pageId).classList.add("active");
    // Update active state for both main nav and mobile nav
    document.querySelectorAll(".nav-link").forEach(link => {
        if (link.dataset.page === pageId) {
            link.classList.add("active");
        } else {
            link.classList.remove("active");
        }
    });
}

mobileMenuButton.addEventListener("click", ()=>{
    mobileMenu.classList.toggle("hidden");
});

// Confirmation Modal Logic
const confirmationModal = document.getElementById('confirmation-modal');
const modalTitle = document.getElementById('modal-title');
const modalMessage = document.getElementById('modal-message');
const modalConfirmBtn = document.getElementById('modal-confirm');
const modalCancelBtn = document.getElementById('modal-cancel');

function showConfirmationModal(message, onConfirm) {
    modalMessage.textContent = message;
    confirmationModal.classList.remove('hidden');

    const confirmHandler = () => {
        onConfirm();
        hideConfirmationModal();
        modalConfirmBtn.removeEventListener('click', confirmHandler);
    };

    const cancelHandler = () => {
        hideConfirmationModal();
        modalConfirmBtn.removeEventListener('click', confirmHandler);
    };

    modalConfirmBtn.addEventListener('click', confirmHandler);
    modalCancelBtn.addEventListener('click', cancelHandler);
}

function hideConfirmationModal() {
    confirmationModal.classList.add('hidden');
}

// --- Authentication Logic ---
switchToSignupButton.addEventListener('click', () => {
    loginSection.classList.add('hidden');
    signupSection.classList.remove('hidden');
    authTitle.textContent = "Sign up for IMS";
    loginErrorEl.textContent = "";
});

switchToLoginButton.addEventListener('click', () => {
    loginSection.classList.remove('hidden');
    signupSection.classList.add('hidden');
    authTitle.textContent = "Log in to IMS";
    loginErrorEl.textContent = "";
});

loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = loginEmailInput.value;
    const password = loginPasswordInput.value;
    try {
        await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
        loginErrorEl.textContent = "Failed to log in: " + error.message;
    }
});

signupForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = signupEmailInput.value;
    const password = signupPasswordInput.value;
    try {
        await createUserWithEmailAndPassword(auth, email, password);
    } catch (error) {
        loginErrorEl.textContent = "Failed to sign up: " + error.message;
    }
});

anonymousLoginButton.addEventListener('click', async () => {
    try {
        await signInAnonymously(auth);
    } catch (error) {
        loginErrorEl.textContent = "Failed to sign in anonymously: " + error.message;
    }
});

displayNameForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = displayNameInput.value;
    const user = auth.currentUser;
    if (user && name) {
        await updateProfile(user, { displayName: name });
        displayNameModal.classList.add('hidden');
        userDisplay.textContent = `Welcome, ${name}!`;
    }
});

logoutButton.addEventListener('click', async () => {
    await signOut(auth);
});

onAuthStateChanged(auth, (user) => {
    if (user) {
        loginPage.classList.add('hidden');
        mainApp.classList.remove('hidden');
        
        // Show display name prompt for new users
        if (!user.displayName) {
             displayNameModal.classList.remove('hidden');
        } else {
            userDisplay.textContent = `Welcome, ${user.displayName}!`;
        }

        // --- Real-time data listeners initialized here ---
        onSnapshot(stockCollection, (snapshot) => {
            allStockData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log("Stock data updated:", allStockData);
            updateDashboard(allStockData);
            applyFiltersAndSort();
            loadStockOptions();
            populateFilterOptions();
        });

        onSnapshot(usedStockCollection, (snapshot) => {
            allUsedData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log("Used stock data updated:", allUsedData);
            updateUsedStock(allUsedData);
        });

        onSnapshot(vendorsCollection, (snapshot) => {
            allVendorsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log("Vendors data updated:", allVendorsData);
            populateVendorSelect();
            renderVendorsTable(allVendorsData);
            populateFilterOptions();
        });

        onSnapshot(activityLogCollection, (snapshot) => {
            const recentActivity = snapshot.docs
                .map(doc => doc.data())
                .sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate())
                .slice(0, 5);
            updateActivityFeed(recentActivity);
        });
        
        showPage('home-page');
    } else {
        loginPage.classList.remove('hidden');
        mainApp.classList.add('hidden');
        showPage('login-page');
    }
});

// Activity Log Function
async function logActivity(action, details) {
    if (auth.currentUser) {
        const userName = auth.currentUser.displayName || auth.currentUser.email || "Anonymous";
        await addDoc(activityLogCollection, {
            action,
            details,
            user: userName,
            timestamp: new Date()
        });
    }
}

// Vendor Management Logic
const addVendorForm = document.getElementById("add-vendor-form");
const vendorsTableBody = document.querySelector("#vendorsTable tbody");
const itemVendorSelect = document.getElementById("itemVendor");

addVendorForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const vendorName = document.getElementById("vendorName").value;
    const contactPerson = document.getElementById("contactPerson").value;
    const contactEmail = document.getElementById("contactEmail").value;

    if (!vendorName) {
        loginErrorEl.textContent = "Vendor name is required.";
        setTimeout(() => loginErrorEl.textContent = "", 3000);
        return;
    }

    await addDoc(vendorsCollection, {
        name: vendorName,
        contactPerson: contactPerson,
        contactEmail: contactEmail,
        createdAt: new Date()
    });
    loginErrorEl.textContent = `Vendor "${vendorName}" added successfully! ✅`;
    setTimeout(() => loginErrorEl.textContent = "", 3000);
    addVendorForm.reset();
    await logActivity("Added", `New vendor: ${vendorName}`);
});

function renderVendorsTable(data) {
    vendorsTableBody.innerHTML = "";
    data.forEach(vendor => {
        vendorsTableBody.innerHTML += `<tr>
            <td class="px-6 py-4">${vendor.name}</td>
            <td class="px-6 py-4">${vendor.contactPerson || 'N/A'}</td>
            <td class="px-6 py-4">${vendor.contactEmail || 'N/A'}</td>
            <td class="px-6 py-4 flex justify-end space-x-2">
                <button class="px-4 py-2 bg-sky-600 text-white rounded-lg shadow-md hover:bg-sky-700 transition-colors" onclick="openEditVendorModal('${vendor.id}')">Edit</button>
                <button class="px-4 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors" onclick="deleteVendor('${vendor.id}')">Delete</button>
            </td>
        </tr>`;
    });
}

window.deleteVendor = async id => {
    showConfirmationModal("Are you sure you want to delete this vendor? This will not remove the vendor from existing stock items.", async () => {
        const vendorData = allVendorsData.find(v => v.id === id);
        await deleteDoc(doc(vendorsCollection, id));
        await logActivity("Deleted", `Deleted vendor: ${vendorData.name}`);
    });
}

function populateVendorSelect() {
    const selects = [document.getElementById("itemVendor"), document.getElementById("edit-itemVendor")];
    selects.forEach(select => {
        const currentSelected = select.value;
        select.innerHTML = `<option value="">-- No Vendor --</option>`;
        allVendorsData.forEach(vendor => {
            const option = document.createElement("option");
            option.value = vendor.id;
            option.textContent = vendor.name;
            select.appendChild(option);
        });
        select.value = currentSelected;
    });
}

// Edit Vendor Modal
window.openEditVendorModal = (id) => {
    const vendor = allVendorsData.find(v => v.id === id);
    if (vendor) {
        document.getElementById('edit-vendor-id').value = vendor.id;
        document.getElementById('edit-vendorName').value = vendor.name;
        document.getElementById('edit-contactPerson').value = vendor.contactPerson || '';
        document.getElementById('edit-contactEmail').value = vendor.contactEmail || '';
        editVendorModal.classList.remove('hidden');
    }
}
editVendorCancelBtn.addEventListener('click', () => editVendorModal.classList.add('hidden'));
editVendorForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('edit-vendor-id').value;
    const name = document.getElementById('edit-vendorName').value;
    const contactPerson = document.getElementById('edit-contactPerson').value;
    const contactEmail = document.getElementById('edit-contactEmail').value;

    await updateDoc(doc(vendorsCollection, id), {
        name,
        contactPerson,
        contactEmail
    });
    loginErrorEl.textContent = `Vendor updated successfully! ✅`;
    setTimeout(() => loginErrorEl.textContent = "", 3000);
    editVendorModal.classList.add('hidden');
    await logActivity("Updated", `Updated vendor: ${name}`);
});

// Stock Form
const stockForm = document.getElementById("stockForm");
stockForm.addEventListener("submit", async e=>{
    e.preventDefault();
    const name = document.getElementById("itemName").value;
    const category = document.getElementById("itemCategory").value;
    const type = document.getElementById("itemType").value;
    const vendorSelect = document.getElementById("itemVendor");
    const vendorId = vendorSelect.value;
    const vendorName = vendorSelect.options[vendorSelect.selectedIndex].text;
    const quantity = parseInt(document.getElementById("itemQuantity").value);
    const unit = document.getElementById("itemUnit").value;
    const price = parseFloat(document.getElementById("itemPrice").value);
    const minStock = parseInt(document.getElementById("itemMinStock").value);

    // Basic validation
    if (quantity < 0 || price < 0 || minStock < 0) {
        loginErrorEl.textContent = "Quantity, price, and min stock cannot be negative.";
        setTimeout(() => loginErrorEl.textContent = "", 3000);
        return;
    }

    await addDoc(stockCollection, {
        name, category, type, quantity, actualQuantity: quantity, unit, price, minStock, createdBy: auth.currentUser.displayName, createdAt: new Date(),
        vendorId: vendorId || null,
        vendorName: vendorId ? vendorName : null
    });
    loginErrorEl.textContent = "Item added! ✅";
    setTimeout(() => loginErrorEl.textContent = "", 3000);
    stockForm.reset();
    await logActivity("Added", `Added ${quantity} of ${name}`);
});

// Quick Add Buttons
const quickAddButtonsContainer = document.getElementById('quick-add-buttons');
const createQuickAddBtn = document.getElementById('create-quick-add-btn');

function createQuickAddButton(itemName, itemQuantity, itemPrice, itemUnit) {
    const button = document.createElement('button');
    button.className = 'quick-add-btn w-full px-6 py-3 bg-sky-50 text-sky-600 rounded-xl font-medium shadow-sm hover:bg-sky-100 transition-colors';
    button.dataset.itemName = itemName;
    button.dataset.itemCategory = 'Misc'; // Default category
    button.dataset.itemType = 'New'; // Default type
    button.dataset.itemQuantity = itemQuantity;
    button.dataset.itemPrice = itemPrice;
    button.dataset.itemMinStock = 0; // Default min stock
    button.dataset.itemUnit = itemUnit || 'pcs';
    button.dataset.itemVendorId = '';
    button.textContent = `Add ${itemQuantity} ${itemName}`;
    quickAddButtonsContainer.appendChild(button);
    // Re-attach event listeners to all quick-add-btns
    attachQuickAddListeners();
}

function attachQuickAddListeners() {
    document.querySelectorAll('.quick-add-btn').forEach(btn => {
        btn.onclick = async () => {
            const name = btn.dataset.itemName;
            const category = btn.dataset.itemCategory;
            const type = btn.dataset.itemType;
            const quantity = parseInt(btn.dataset.itemQuantity);
            const price = parseFloat(btn.dataset.itemPrice);
            const minStock = parseInt(btn.dataset.itemMinStock);
            const unit = btn.dataset.itemUnit;
            const vendorId = btn.dataset.itemVendorId || null;
            const vendorName = vendorId ? allVendorsData.find(v => v.id === vendorId)?.name : null;
    
            await addDoc(stockCollection, {
                name, category, type, quantity, actualQuantity: quantity, unit, price, minStock, createdBy: auth.currentUser.displayName, createdAt: new Date(),
                vendorId, vendorName
            });
            loginErrorEl.textContent = `Successfully added ${quantity} of ${name}!`;
            setTimeout(() => loginErrorEl.textContent = "", 3000);
            await logActivity("Added", `Quick-added ${quantity} of ${name}`);
        };
    });
}
attachQuickAddListeners();

createQuickAddBtn.addEventListener('click', () => {
    const itemName = prompt("Enter the item name:");
    const itemQuantity = prompt("Enter the quantity:");
    const itemPrice = prompt("Enter the price per unit:");
    const itemUnit = prompt("Enter the unit (e.g., pcs, kg, m):") || 'pcs';

    if (itemName && !isNaN(parseInt(itemQuantity)) && !isNaN(parseFloat(itemPrice))) {
        createQuickAddButton(itemName, parseInt(itemQuantity), parseFloat(itemPrice), itemUnit);
    } else {
        loginErrorEl.textContent = "Invalid input. Please enter a valid name, quantity, and price.";
        setTimeout(() => loginErrorEl.textContent = "", 3000);
    }
});

// Edit Stock Modal
window.openEditStockModal = (id) => {
    const item = allStockData.find(s => s.id === id);
    if (item) {
        document.getElementById('edit-stock-id').value = item.id;
        document.getElementById('edit-itemName').value = item.name;
        document.getElementById('edit-itemCategory').value = item.category || '';
        document.getElementById('edit-itemType').value = item.type;
        document.getElementById('edit-itemQuantity').value = item.quantity;
        document.getElementById('edit-itemUnit').value = item.unit || 'pcs';
        document.getElementById('edit-itemPrice').value = item.price;
        document.getElementById('edit-itemMinStock').value = item.minStock;
        document.getElementById('edit-itemVendor').value = item.vendorId || '';
        editStockModal.classList.remove('hidden');
    }
}
editStockCancelBtn.addEventListener('click', () => editStockModal.classList.add('hidden'));
editStockForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('edit-stock-id').value;
    const name = document.getElementById('edit-itemName').value;
    const category = document.getElementById('edit-itemCategory').value;
    const type = document.getElementById('edit-itemType').value;
    const quantity = parseInt(document.getElementById('edit-itemQuantity').value);
    const unit = document.getElementById('edit-itemUnit').value;
    const price = parseFloat(document.getElementById('edit-itemPrice').value);
    const minStock = parseInt(document.getElementById('edit-itemMinStock').value);
    const vendorSelect = document.getElementById("edit-itemVendor");
    const vendorId = vendorSelect.value;
    const vendorName = vendorSelect.options[vendorSelect.selectedIndex].text;

    if (quantity < 0 || price < 0 || minStock < 0) {
        loginErrorEl.textContent = "Quantity, price, and min stock cannot be negative.";
        setTimeout(() => loginErrorEl.textContent = "", 3000);
        return;
    }

    await updateDoc(doc(stockCollection, id), {
        name, category, type, quantity, unit, price, minStock,
        vendorId: vendorId || null,
        vendorName: vendorId ? vendorName : null
    });
    loginErrorEl.textContent = `Item updated successfully! ✅`;
    setTimeout(() => loginErrorEl.textContent = "", 3000);
    editStockModal.classList.add('hidden');
    await logActivity("Updated", `Updated item: ${name}`);
});

// Load Stock Details
function displayStockData(data) {
    const tableBody = document.querySelector("#stockTable tbody");
    tableBody.innerHTML = "";
    if (data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="11" class="px-6 py-4 text-center text-gray-500">No items found.</td></tr>`;
        return;
    }
    data.forEach(d => {
        const isLowStock = d.quantity <= d.minStock;
        tableBody.innerHTML += `<tr>
            <td class="px-6 py-4">${d.name}</td>
            <td class="px-6 py-4">${d.category || ''}</td>
            <td class="px-6 py-4">${d.type}</td>
            <td class="px-6 py-4">${d.actualQuantity || d.quantity}</td>
            <td class="px-6 py-4 ${isLowStock ? 'text-red-600 font-semibold' : ''}">${d.quantity}</td>
            <td class="px-6 py-4">${d.unit || ''}</td>
            <td class="px-6 py-4">${d.minStock}</td>
            <td class="px-6 py-4">$${d.price}</td>
            <td class="px-6 py-4">${d.vendorName || 'N/A'}</td>
            <td class="px-6 py-4">${d.createdBy || 'Unknown'}</td>
            <td class="px-6 py-4 flex justify-end space-x-2">
                <button class="px-4 py-2 bg-sky-600 text-white rounded-lg shadow-md hover:bg-sky-700 transition-colors" onclick="openEditStockModal('${d.id}')">Edit</button>
                <button class="px-4 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors" onclick="deleteItem('${d.id}')">Delete</button>
            </td>
        </tr>`;
    });
}

// Advanced Search and Filtering
const stockSearch = document.getElementById('stock-search');
const filterCategorySelect = document.getElementById('filter-category');
const filterVendorSelect = document.getElementById('filter-vendor');
const filterLowStockCheckbox = document.getElementById('filter-low-stock');

function applyFiltersAndSort() {
    const searchTerm = stockSearch.value.toLowerCase();
    const filterCategory = filterCategorySelect.value;
    const filterVendor = filterVendorSelect.value;
    const showLowStock = filterLowStockCheckbox.checked;

    let filteredData = allStockData.filter(d => {
        const matchesSearch = d.name.toLowerCase().includes(searchTerm);
        const matchesCategory = !filterCategory || d.category === filterCategory;
        const matchesVendor = !filterVendor || d.vendorId === filterVendor;
        const matchesLowStock = !showLowStock || d.quantity <= d.minStock;
        return matchesSearch && matchesCategory && matchesVendor && matchesLowStock;
    });

    // Apply sorting
    const sortedHeader = document.querySelector('th[data-sort][data-order]');
    let sortBy = null;
    let sortOrder = 'asc';
    
    // Safely get sorting data only if the element exists
    if (sortedHeader) {
        sortBy = sortedHeader.dataset.sort;
        sortOrder = sortedHeader.dataset.order;
    }

    if (sortBy) {
        filteredData = [...filteredData].sort((a, b) => {
            let aValue = a[sortBy];
            let bValue = b[sortBy];
            if (typeof aValue === 'string') {
                aValue = aValue ? aValue.toLowerCase() : '';
                bValue = bValue ? bValue.toLowerCase() : '';
            }
            if (aValue < bValue) return sortOrder === 'asc' ? -1 : 1;
            if (aValue > bValue) return sortOrder === 'asc' ? 1 : -1;
            return 0;
        });
    }

    displayStockData(filteredData);
}

stockSearch.addEventListener('input', applyFiltersAndSort);
filterCategorySelect.addEventListener('change', applyFiltersAndSort);
filterVendorSelect.addEventListener('change', applyFiltersAndSort);
filterLowStockCheckbox.addEventListener('change', applyFiltersAndSort);

function populateFilterOptions() {
    // Populate Category Filter
    const categories = [...new Set(allStockData.map(d => d.category).filter(Boolean))];
    const currentCatFilter = filterCategorySelect.value;
    filterCategorySelect.innerHTML = `<option value="">All Categories</option>`;
    categories.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        filterCategorySelect.appendChild(option);
    });
    filterCategorySelect.value = currentCatFilter;

    // Populate Vendor Filter
    const currentVendorFilter = filterVendorSelect.value;
    filterVendorSelect.innerHTML = `<option value="">All Vendors</option>`;
    allVendorsData.forEach(vendor => {
        const option = document.createElement("option");
        option.value = vendor.id;
        option.textContent = vendor.name;
        filterVendorSelect.appendChild(option);
    });
    filterVendorSelect.value = currentVendorFilter;
}

// Sorting
document.querySelectorAll('th[data-sort]').forEach(header => {
    header.addEventListener('click', () => {
        const sortBy = header.dataset.sort;
        const sortOrder = header.dataset.order === 'asc' ? 'desc' : 'asc';
        document.querySelectorAll('th[data-sort]').forEach(th => th.removeAttribute('data-order'));
        header.dataset.order = sortOrder;
        applyFiltersAndSort();
    });
});
// Download CSV for Stock Details
document.getElementById('download-stock-csv').addEventListener('click', () => {
    const dataToExport = allStockData.map(({ id, createdBy, createdAt, ...rest }) => rest);
    exportToCsv('stock-details.csv', dataToExport);
});

// Delete Stock
window.deleteItem = async id => {
    showConfirmationModal("Are you sure you want to delete this item?", async () => {
        const stockData = allStockData.find(d => d.id === id);
        await deleteDoc(doc(stockCollection, id));
        await logActivity("Deleted", `Deleted item: ${stockData.name}`);
    });
}

// Use Stock
const useStockForm = document.getElementById("useStockForm");
const useItemSelect = document.getElementById("useItemSelect");
const currentStockInfo = document.getElementById("current-stock-info");
const transactionHistoryList = document.getElementById("transaction-history");

useItemSelect.addEventListener('change', () => {
    const selectedId = useItemSelect.value;
    const selectedItem = allStockData.find(item => item.id === selectedId);
    if (selectedItem) {
        currentStockInfo.textContent = `${selectedItem.quantity} ${selectedItem.unit || ''} units available.`;
    } else {
        currentStockInfo.textContent = '-';
    }
});

useStockForm.addEventListener("submit", async e=>{
    e.preventDefault();
    const id = useItemSelect.value;
    const qtyUse = parseInt(document.getElementById("useQuantity").value);

    if(!id || qtyUse <= 0 || isNaN(qtyUse)) {
        loginErrorEl.textContent = "Please select an item and enter a valid quantity.";
        setTimeout(() => loginErrorEl.textContent = "", 3000);
        return;
    }

    try {
        const docRef = doc(stockCollection, id);
        const stockData = allStockData.find(item => item.id === id);

        if (stockData.quantity < qtyUse) {
            loginErrorEl.textContent = `Not enough stock. Only ${stockData.quantity} available.`;
            setTimeout(() => loginErrorEl.textContent = "", 3000);
            return;
        }

        const newQuantity = stockData.quantity - qtyUse;
        await updateDoc(docRef, { quantity: newQuantity });

        // Add Used Stock Entry
        await addDoc(usedStockCollection, {
            name: stockData.name,
            category: stockData.category,
            quantityUsed: qtyUse,
            unit: stockData.unit,
            usedAt: new Date(),
            value: qtyUse * stockData.price
        });

        await logActivity("Used", `Used ${qtyUse} of ${stockData.name}`);
        
        useStockForm.reset();
        loginErrorEl.textContent = "Stock used successfully! ✅";
        setTimeout(() => loginErrorEl.textContent = "", 3000);
    } catch(err) {
        console.error("Error using stock: ", err);
        loginErrorEl.textContent = "An error occurred while using stock.";
        setTimeout(() => loginErrorEl.textContent = "", 3000);
    }
});

// Load Options in Use Stock Select
function loadStockOptions(){
    const select = document.getElementById("useItemSelect");
    select.innerHTML = "";
    select.innerHTML += `<option value="" disabled selected>-- Select an item --</option>`;
    allStockData.forEach(d=>{
        select.innerHTML += `<option value="${d.id}">${d.name} (Qty: ${d.quantity} ${d.unit || ''})</option>`;
    });
}

// Used Stock Report
let allUsedDataFiltered = [];
function updateUsedStock(data){
    const tableBody = document.querySelector("#usedStockTable tbody");
    const totalUsedItemsEl = document.getElementById("total-used-items");
    const totalUsedValueEl = document.getElementById("total-used-value");
    tableBody.innerHTML = "";
    
    allUsedDataFiltered = data;
    const dateFilter = document.getElementById("used-stock-date-filter").value;
    if (dateFilter) {
        allUsedDataFiltered = data.filter(d => {
            const usedDate = d.usedAt.toDate().toISOString().split('T')[0];
            return usedDate === dateFilter;
        });
    }

    let totalUsedItems = 0;
    let totalUsedValue = 0;

    allUsedDataFiltered.forEach(d=>{
        totalUsedItems += d.quantityUsed;
        totalUsedValue += d.value || 0;
        const date = d.usedAt?.toDate ? d.usedAt.toDate().toLocaleString() : new Date(d.usedAt).toLocaleString();
        tableBody.innerHTML += `<tr>
            <td class="px-6 py-4">${d.name}</td>
            <td class="px-6 py-4">${d.category || ''}</td>
            <td class="px-6 py-4">${d.quantityUsed}</td>
            <td class="px-6 py-4">${d.unit || ''}</td>
            <td class="px-6 py-4">${date}</td>
            <td class="px-6 py-4 flex justify-end space-x-2">
                <button class="px-4 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors" onclick="deleteUsedItem('${d.id}')">Delete</button>
            </td>
        </tr>`;
    });

    totalUsedItemsEl.innerText = totalUsedItems;
    totalUsedValueEl.innerText = `$${totalUsedValue.toFixed(2)}`;

    // Populate recent transactions
    const recentTransactions = [...data]
        .sort((a, b) => b.usedAt.toDate() - a.usedAt.toDate())
        .slice(0, 5);

    transactionHistoryList.innerHTML = recentTransactions.length > 0 ? '' : '<li class="text-gray-600">No recent transactions.</li>';
    recentTransactions.forEach(t => {
        const date = t.usedAt?.toDate ? t.usedAt.toDate().toLocaleString() : new Date(t.usedAt).toLocaleString();
        transactionHistoryList.innerHTML += `<li class="text-gray-600"><strong>${t.name}</strong>: ${t.quantityUsed} ${t.unit || ''} used on ${date}</li>`;
    });
}

document.getElementById("used-stock-date-filter").addEventListener("change", e => {
    updateUsedStock(allUsedData);
});

// Download CSV for Used Stock Report
document.getElementById('download-used-csv').addEventListener('click', () => {
    // Re-filter the data just before export to ensure it matches what's displayed
    const dataToExport = allUsedData.filter(d => {
        const dateFilter = document.getElementById("used-stock-date-filter").value;
        if (!dateFilter) return true;
        const usedDate = d.usedAt.toDate().toISOString().split('T')[0];
        return usedDate === dateFilter;
    }).map(({ id, ...rest }) => ({
        ...rest,
        usedAt: rest.usedAt.toDate().toLocaleString()
    }));
    exportToCsv('used-stock-report.csv', dataToExport);
});

// Delete Used Stock
window.deleteUsedItem = async id => {
    showConfirmationModal("Are you sure you want to delete this used stock entry?", async () => {
        try {
            await deleteDoc(doc(usedStockCollection, id));
            await logActivity("Deleted", `Deleted used stock entry with ID: ${id}`);
        } catch(err) {
            console.error("Error deleting used stock: ", err);
            loginErrorEl.textContent = "An error occurred while deleting the entry.";
            setTimeout(() => loginErrorEl.textContent = "", 3000);
        }
    });
}

// Dashboard Metrics
let lowStockChart = null;
let categoryBarChart = null;
let categoryPieChart = null;
let topValueChart = null;

// Global variable for the full, unfiltered data
let inventoryData = [];

// Main function to update dashboard (accepts optional filtered data)
function updateDashboard(dataToDisplay = inventoryData) {
    let totalItems = 0, totalValue = 0;
    const categories = new Set();
    const categoryCounts = {};
    const lowStockItems = [];

    // Process data
    dataToDisplay.forEach(d => {
        totalItems += d.quantity;
        totalValue += d.quantity * d.price;
        if (d.category) categories.add(d.category);
        if (d.category) categoryCounts[d.category] = (categoryCounts[d.category] || 0) + d.quantity;
        if (d.quantity <= d.minStock) lowStockItems.push(d);
    });

    // Update Dashboard & Home cards
    document.getElementById("total-items").innerText = totalItems;
    document.getElementById("total-value").innerText = `$${totalValue.toFixed(2)}`;
    document.getElementById("unique-categories").innerText = categories.size;
    document.getElementById("home-total-items").innerText = totalItems;
    document.getElementById("home-total-value").innerText = `$${totalValue.toFixed(2)}`;
    document.getElementById("home-unique-categories").innerText = categories.size;

    // --- Low Stock Alerts ---
    const lowStockAlertsContainer = document.getElementById("low-stock-alerts");
    lowStockAlertsContainer.innerHTML = '';
    if (lowStockItems.length === 0) {
        lowStockAlertsContainer.innerHTML = `
            <div class="bg-white rounded-2xl shadow-lg p-6 text-center border border-gray-100">
                <p class="text-gray-500">No low stock items. All good! 😊</p>
            </div>
        `;
    } else {
        lowStockItems.forEach(item => {
            lowStockAlertsContainer.innerHTML += `
                <div class="bg-white rounded-2xl shadow-lg p-6 flex justify-between items-center border border-red-300 animate-pulse-once">
                    <div>
                        <p class="font-semibold text-red-600">${item.name}</p>
                        <p class="text-sm text-gray-500">Current: ${item.quantity} ${item.unit || ''} / Min: ${item.minStock}</p>
                    </div>
                    <a href="#stock-details" class="nav-link text-sky-600 hover:underline" data-page="stock-details-page">View Details</a>
                </div>
            `;
        });
    }

    // --- Category & Chart Data ---
    const categoryLabels = Object.keys(categoryCounts);
    const categoryData = Object.values(categoryCounts);

    const valuedItems = dataToDisplay
        .map(d => ({ name: d.name, value: d.quantity * d.price }))
        .sort((a, b) => b.value - a.value)
        .slice(0, 5);
    const topValueLabels = valuedItems.map(i => i.name);
    const topValueData = valuedItems.map(i => i.value);

    // --- Filter Dropdown ---
    const filterSelect = document.getElementById("category-filter");
    if (filterSelect && filterSelect.options.length === 1) {
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            filterSelect.appendChild(option);
        });

        filterSelect.addEventListener('change', e => {
            const selectedCategory = e.target.value;
            if (selectedCategory === "all") {
                updateDashboard(inventoryData);
            } else {
                const filteredData = inventoryData.filter(item => item.category === selectedCategory);
                updateDashboard(filteredData);
            }
        });
    }

    // --- Recent Additions Feed ---
    const recentAdditionsContainer = document.getElementById("recent-additions-feed");
    if (recentAdditionsContainer) {
        recentAdditionsContainer.innerHTML = '';
        const sortedByDate = [...dataToDisplay].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        const recentItems = sortedByDate.slice(0, 5);

        if (recentItems.length === 0) {
            recentAdditionsContainer.innerHTML = `<p class="text-gray-500 text-center">No recent additions.</p>`;
        } else {
            recentItems.forEach(item => {
                const itemDate = new Date(item.timestamp).toLocaleDateString();
                recentAdditionsContainer.innerHTML += `
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-500">Added: ${item.quantity} units</p>
                        </div>
                        <span class="text-xs text-gray-400">${itemDate}</span>
                    </div>
                `;
            });
        }
    }

    // --- Charts ---
    const chartColors = ['#6c757d', '#6a9955', '#c97f47', '#5e7090', '#d4b28c', '#a15c54', '#8b9b7e', '#a88981', '#546e7a', '#9e8a5b'];

    // Category Bar Chart
    const ctxBar = document.getElementById("category-bar-chart").getContext("2d");
    if (categoryBarChart) categoryBarChart.destroy();
    categoryBarChart = new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: categoryLabels,
            datasets: [{
                label: 'Quantity',
                data: categoryData,
                backgroundColor: categoryLabels.map((_, i) => chartColors[i % chartColors.length]),
                borderColor: categoryLabels.map((_, i) => chartColors[i % chartColors.length]),
                borderWidth: 1
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }, x: { grid: { display: false } } } }
    });

    // Category Pie Chart
    const ctxPie = document.getElementById("category-pie-chart").getContext("2d");
    if (categoryPieChart) categoryPieChart.destroy();
    categoryPieChart = new Chart(ctxPie, {
        type: 'pie',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryData,
                backgroundColor: categoryLabels.map((_, i) => chartColors[i % chartColors.length]),
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: { responsive: true }
    });

    // Low Stock Chart
    const ctxLowStock = document.getElementById("low-stock-chart").getContext("2d");
    if (lowStockChart) lowStockChart.destroy();
    lowStockChart = new Chart(ctxLowStock, {
        type: 'bar',
        data: {
            labels: lowStockItems.map(i => i.name),
            datasets: [{ label: 'Quantity', data: lowStockItems.map(i => i.quantity), backgroundColor: '#dc2626', borderColor: '#b91c1c', borderWidth: 1 }]
        },
        options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true }, y: { beginAtZero: true } } }
    });

    // Top 5 Most Valuable Items Chart
    const ctxTopValue = document.getElementById("top-value-chart").getContext("2d");
if (topValueChart) topValueChart.destroy();

topValueChart = new Chart(ctxTopValue, {
    type: 'bar',
    data: {
        labels: topValueLabels,
        datasets: [{
            label: 'Total Value ($)',
            data: topValueData,
            backgroundColor: [
                '#38bdf8', // blue
                '#f87171', // red
                '#4ade80', // green
                '#facc15', // yellow
                '#a78bfa', // purple
                '#fb923c'  // orange
            ],
            borderColor: [
                '#0ea5e9',
                '#ef4444',
                '#22c55e',
                '#eab308',
                '#8b5cf6',
                '#f97316'
            ],
            borderWidth: 1
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            x: {
                beginAtZero: true,
                title: { display: true, text: 'Total Value ($)' }
            },
            y: { beginAtZero: true }
        }
    }
});

}


function updateActivityFeed(recentActivity) {
    const activityFeedList = document.getElementById("activity-feed");
    activityFeedList.innerHTML = recentActivity.length > 0 ? '' : '<li class="text-gray-600">No recent activity.</li>';
    recentActivity.forEach(activity => {
        const time = activity.timestamp.toDate().toLocaleTimeString();
        activityFeedList.innerHTML += `<li class="text-gray-600"><strong>[${time} by ${activity.user}]</strong> ${activity.action}: ${activity.details}</li>`;
    });
}
// Universal CSV Export Function
function exportToCsv(filename, data) {
    if (!data || data.length === 0) {
        loginErrorEl.textContent = "No data to export!";
        setTimeout(() => loginErrorEl.textContent = "", 3000);
        return;
    }

    const headers = Object.keys(data[0]);
    const csvRows = [];
    csvRows.push(headers.join(',')); // Add header row

    for (const row of data) {
        const values = headers.map(header => {
            const val = row[header] !== null && row[header] !== undefined ? row[header] : '';
            const escaped = ('' + val).replace(/"/g, '""');
            return `"${escaped}"`;
        });
        csvRows.push(values.join(','));
    }

    const csvString = csvRows.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}
</script>
</body>
</html>
